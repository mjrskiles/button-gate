# Test menu toggle gesture behavior
# Verifies that:
# 1. Menu enter gesture (A hold + B hold) works
# 2. Button release does NOT exit menu (output stays stable)
# 3. Menu toggle gesture again exits menu
# 4. Output follows input correctly in gate mode after menu exit

# Wait for app init
1000    log     Starting menu toggle test

# === Test 1: Enter menu with A+B hold gesture ===
0       log     Test 1: Entering menu with A hold + B hold gesture

# Press A first
0       press   a
20      assert  output high     # Gate mode: output follows input

# While holding A, press B
100     press   b

# Hold both past threshold (500ms for B to reach hold)
# A was pressed first, then B reaches threshold -> EVT_MENU_TOGGLE
550     log     Should now be in menu

# === Test 2: Release buttons - should NOT exit menu ===
0       log     Test 2: Releasing buttons (should stay in menu)

# Release A - output should stay HIGH (frozen at last state when entering menu)
50      release a
50      assert  output high     # Output frozen at HIGH from when we entered menu
50      log     Button A released - output still high (frozen in menu)

# Release B
50      release b
50      log     Button B released

# Output should still be HIGH because mode handler isn't running in menu
100     log     Testing that we are in menu (output should stay frozen)
0       press   a
50      assert  output high     # Output stays HIGH - mode handler not running
0       release a
50      assert  output high     # Still HIGH - not following input because we're in menu
50      log     Confirmed: output frozen while in menu

# === Test 3: Exit menu with same gesture ===
100     log     Test 3: Exiting menu with A hold + B hold gesture

# Press A first
0       press   a
100     press   b
# Wait for B to reach hold threshold
550     log     Should have exited menu

# Release buttons
50      release a
50      release b

# === Test 4: Verify back in perform mode (gate mode active) ===
100     log     Test 4: Verifying gate mode is active again

0       press   a
20      assert  output high     # Gate mode: output follows input
100     release a
20      assert  output low

# Done
100     log     Menu toggle test complete
0       quit
